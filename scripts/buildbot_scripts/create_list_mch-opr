#!/bin/bash

# abort on error
set -euo pipefail

cd $(dirname "${BASH_SOURCE[0]}")
basedir=$(cd ../.. && pwd)

#############################################################################
##
## create mch-opr list
##
#############################################################################

listname=${1:-mch-opr}
./rmlist $listname

machine=balfrin
./addmachine $machine --list $listname
./addbuilder balfrin_gpu_nvidia_mixed --machine $machine --build_script="./config/buildbot/balfrin_gpu_nvidia_mixed" --builderflags="Active" --list $listname


# add bench experiments
./addexp "checksuite.icon-dev/check.mch_icon-ch2"  --builders "balfrin_gpu_nvidia_mixed" --list $listname --runflags "cpu_time=01:20:00"
./addexp "checksuite.icon-dev/check.mch_icon-ch1"  --builders "balfrin_gpu_nvidia_mixed" --list $listname --runflags "cpu_time=01:20:00"
./addexp "checksuite.icon-dev/check.mch_kenda-ch1" --builders "balfrin_gpu_nvidia_mixed" --list $listname --runflags "cpu_time=00:20:00"

add_store_performance_exp () {
    exp=$1
    cp ${basedir}/run/performance/pp.store_performance ${basedir}/run/performance/pp.store_performance_${exp}
    ./addexp "performance/pp.store_performance_${exp}"  --builders "balfrin_gpu_nvidia_mixed" --list $listname --runflags "cpu_time=00:05:00"
    ./adddep --from-experiment "performance/pp.store_performance_${exp}" --to-experiment "checksuite.icon-dev/check.${exp}" --builders "balfrin_gpu_nvidia_mixed" --list $listname
}

# create a store script for each experiment and add the exp and dep
add_store_performance_exp "mch_icon-ch2"
add_store_performance_exp "mch_icon-ch1"
add_store_performance_exp "mch_kenda-ch1"

#lets see the list
./lslist $listname
#-----------------------------------------------------------


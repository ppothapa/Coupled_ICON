# ----------------------------------------------------------------------------
#
# ICON-waves.
#
# The purpose is the technical testing of the ICON-waves.
#
# Mikhail Dobrynin, 2022
#
#=============================================================================


nd_change_to_experiment_dir # function in ../add_run_routines

# Combine START and MODEL if START_MODEL is not already set.
# START_MODEL is used to ease the execution of a machine that uses a complex
# mpirun command with multiple binaries
START_MODEL="${START_MODEL:=$START $MODEL}"

# set icon_data_poolFolder
icon_data_poolFolder="${icon_data_rootFolder:-/pool/data/ICON}"
if [[ -d "$icon_data_poolFolder/buildbot_data/nwp" ]]; then
          icon_data_poolFolder="$icon_data_poolFolder/buildbot_data/nwp"
fi

# base directory for ICON sources, binary and auxilary data:
ICONDIR="${basedir}" # basedir can be set with create_target_header

# root directory for input data
DATAROOT="${icon_data_poolFolder}/Checksuite_data"

# directory with input grids:
#GRIDDIR=${DATAROOT}/GRF_R2B6N8_IFStest

# directory with input data from IFS:
#IFSDATADIR=${DATAROOT}/Inidata_R2B6N7_IFStest

# directory with external parameter data:
#EXTPARDIR=${DATAROOT}/Extpar_R2B6N8_IFStest

# ----------------------------------------------------------------------------
# copy input data: grids, external parameters, model
# ----------------------------------------------------------------------------

# delete existing restart files
#rm -rf *restart_*

# grid files
#ln -sf ${GRIDDIR}/iconR2B05_DOM00.nc iconR2B05_DOM00.nc
#ln -sf ${GRIDDIR}/iconR2B06_DOM01.nc iconR2B06_DOM01.nc
#ln -sf ${GRIDDIR}/iconR2B07_DOM02.nc iconR2B07_DOM02.nc

# external parameter (from ExtPar tool)
#ln -sf ${EXTPARDIR}/extpar_R2B06_DOM01.nc extpar_iconR2B06_DOM01.nc
#ln -sf ${EXTPARDIR}/extpar_R2B07_DOM02.nc extpar_iconR2B07_DOM02.nc

# interpolated IFS data
#ln -sf $IFSDATADIR/prepiconR2B06_DOM01_2012062100.nc ifs2icon_R2B06_DOM01.nc
#ln -sf $IFSDATADIR/prepiconR2B07_DOM02_2012062100.nc ifs2icon_R2B07_DOM02.nc

# files needed for radiation
#ln -sf ${ICONDIR}/data/ECHAM6_CldOptProps.nc .
#ln -sf ${ICONDIR}/data/rrtmg_lw.nc .

# copy binary
cp -p $MODEL icon


# ----------------------------------------------------------------------------
# grid namelist settings
# ----------------------------------------------------------------------------
wave_grid="iconR2B06_DOM01.nc"

wave_namelist=NAMELIST_${EXPNAME}

start_date="1979-01-01T00:00:00Z"
  end_date="1979-01-02T00:00:00Z"

dtime=600

cat > icon_master.namelist << EOF
&master_nml
 lrestart                     = .false.
/
&time_nml
 is_relative_time = .false.
/
&master_time_control_nml
 calendar             = "proleptic gregorian"
 experimentStartDate  = "$start_date"
 experimentStopDate   = "$end_date"
/
&master_model_nml
 model_type                  = 98
 model_name                  = "wave"
 model_namelist_filename     = "$wave_namelist"
 model_min_rank              = 1
 model_max_rank              = 65536
 model_inc_rank              = 1
/
EOF



# ----------------------------------------------------------------------------
# run the model!
# ----------------------------------------------------------------------------

$START_MODEL
EXIT_STATUS=$?

if [ "$EXIT_STATUS" -ne "0" ]; then
  echo "EXIT_STATUS: $EXIT_STATUS"
  exit $EXIT_STATUS
fi

# ----------------------------------------------------------------------------
#done # iterations for restart testing
# ----------------------------------------------------------------------------

echo "EXIT_STATUS: $EXIT_STATUS"
exit $EXIT_STATUS


